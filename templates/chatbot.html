<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PKonnect Messenger</title>
  
  <style>
    
    :root {
      --accent: #992126; /* muted maroon */
      --accent-dark: #7f1720;
      --panel: #ffffff;
      --page-bg: rgba(247,249,251,1);
      --text: #0b2340;
      --muted-bg: #f1f5f9;
    }

    /* Dark-theme variable overrides when .dark is present on <html> */
    html.dark {
      --accent: #6b3a3a; /* softened for dark */
      --accent-dark: #4d2a2a;
      --panel: #071428;
      --page-bg: #041123;
      --text: #e8f1ff;
      --muted-bg: rgba(255,255,255,0.04);
    }

    /* Make the chat occupy the whole viewport */
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: transparent;
      color: var(--text);
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .chat-container {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      width: auto; height: auto;
      background: var(--panel);
      border-radius: 0;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 0;
      z-index: 9999;
    }

    /* header stays pinned */
    .chat-header {
      background: linear-gradient(180deg, rgba(0,0,0,0.04)), linear-gradient(180deg, var(--accent), var(--accent-dark));
      color: #fff;
      padding: 14px 16px;
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.6px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .chat-header-actions {
      position: absolute;
      right: 12px;
      top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .theme-toggle {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      padding: 8px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(2,6,20,0.06);
    }
    .theme-toggle svg { width:18px; height:18px; }

    .chat-login-btn {
      background: #fff;
      color: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 10px 30px rgba(3,6,23,0.06);
    }

    .chat-box {
      flex: 1 1 auto;
      padding: 18px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--muted-bg);
    }

    .bubble {
      max-width: 78%;
      padding: 10px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.45;
      word-break: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      margin-bottom: 8px;
      display: inline-block;
      position: relative;
      clear: both;
      white-space: pre-wrap;
      text-align: left;
    }
    .bubble.user { background: linear-gradient(180deg,var(--accent),var(--accent-dark)); color: #fff; align-self: flex-end; border-bottom-right-radius: 8px; }
    .bubble.bot { background: var(--panel); color: var(--text); align-self: flex-start; border-bottom-left-radius: 6px; }

    .typing-indicator { background: var(--muted-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 6px; max-width: 75%; padding: 12px 16px; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .typing-dots { display: inline-flex; align-items:center; gap:6px }
    .typing-dots span { height: 8px; width: 8px; background-color: #666; border-radius:50%; animation: typing 1.4s infinite ease-in-out }
    .typing-dots span:nth-child(1){ animation-delay: -0.32s } .typing-dots span:nth-child(2){ animation-delay: -0.16s }
    @keyframes typing { 0%,80%,100% { transform: scale(.8); opacity:.5 } 40% { transform: scale(1); opacity:1 } }

    .chat-input-area { display:flex; padding:12px; background: linear-gradient(180deg,var(--panel), rgba(250,250,250,0.98)); border-top: 1px solid rgba(0,0,0,0.04); }
    .chat-input-area input[type="text"] { flex:1; padding:10px 14px; border:none; border-radius:20px; font-size:1rem; outline:none; background:var(--panel); margin-right:10px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); color: var(--text); }
    .chat-input-area button { background: linear-gradient(180deg,var(--accent),var(--accent-dark)); color:#fff; border:none; border-radius:14px; padding:10px 18px; font-size:0.98rem; cursor:pointer; transition: transform .12s ease; }
    .chat-input-area button:hover { transform: translateY(-2px) }

    .dark .chat-container 
    { background: var(--panel); 
      color: var(--text); }
    .dark .chat-header {
       background: linear-gradient(180deg,var(--accent),var(--accent-dark)); }
    .dark .chat-login-btn { background: rgba(255,255,255,0.04); color: var(--text); border: 1px solid rgba(255,255,255,0.04); }
    .dark .bubble.bot { background: var(--muted-bg); color: var(--text); }
    .dark .typing-indicator { background: var(--muted-bg); color: var(--text); }

    @media (max-width:600px){ .chat-input-area input[type="text"] { font-size: 0.95rem } }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='img/image.png') }}" type="image/png">
  <meta name="theme-color" content="#4267b2">
</head>
<body>
  
  <div class="chat-container">
    <div class="chat-header">
      <button id="homeBtn" onclick="goToHome()" class="chat-login-btn" title="Go to homepage" style="position: absolute; left: 12px; top: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
      </button>
      <span id="chatTitle">PKonnect Messenger</span>
      <div class="chat-header-actions">
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M2 12h2M20 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
        </button>
        <button id="clearBtn" onclick="clearConversation()" class="chat-login-btn" title="Clear conversation">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
        </button>
        <button id="loginBtn" onclick="handleAuthAction()" class="chat-login-btn">Login</button>
      </div>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <form class="chat-input-area" onsubmit="sendMessage(event)">
      <input type="text" id="msg" placeholder="Type your message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>
  <script>
    const chatBox = document.getElementById("chat-box");
    const msgInput = document.getElementById("msg");
    
    // Store login state
    let userLoginState = {
      logged_in: false,
      user_type: 'guest',
      role: null,
      department: null
    };

    // Check login status on load
    window.onload = function() {
      checkLoginStatus();
      loadHistory();
    };

    function loadHistory() {
      fetch('/history')
        .then(res => res.json())
        .then(data => {
          if (data.history) {
            data.history.forEach(item => {
              appendMessage(item.question, "user");
              appendMessage(item.answer, "bot");
            });
          }
        });
    }

    function checkLoginStatus() {
      fetch('/check-login-status')
        .then(res => res.json())
        .then(data => {
          userLoginState = data;
          updateUIForLoginState(data);
        })
        .catch(err => {
          console.error('Failed to check login status:', err);
        });
    }

    function updateUIForLoginState(data) {
      const loginBtn = document.getElementById('loginBtn');
      const chatTitle = document.getElementById('chatTitle');
      
      if (data.logged_in) {
        loginBtn.textContent = 'Logout';
        const roleText = data.role ? data.role.charAt(0).toUpperCase() + data.role.slice(1) : 'User';
        const deptText = data.department || '';
        chatTitle.textContent = `PKonnect - ${roleText}${deptText ? ' (' + deptText + ')' : ''}`;
      } else {
        loginBtn.textContent = 'Login';
        chatTitle.textContent = 'PKonnect Messenger (Guest)';
      }
    }

    function goToHome() {
      window.location.href = '/';
    }

    function handleAuthAction() {
      if (userLoginState.logged_in) {
        // Logout
        if (confirm('Are you sure you want to logout?')) {
          fetch('/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              userLoginState = {
                logged_in: false,
                user_type: 'guest',
                role: null,
                department: null
              };
              updateUIForLoginState(userLoginState);
              // Clear chat box when logging out (new session will start)
              chatBox.innerHTML = '';
              appendMessage('You have been logged out. Starting fresh as guest.', 'bot');
            }
          });
        }
      } else {
        // Redirect to login flow
        window.location.href = '/select-department';
      }
    }

    function clearConversation() {
      if (confirm('Clear the conversation history?')) {
        fetch('/clear-conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          // Clear chat box
          chatBox.innerHTML = '';
          appendMessage('Conversation cleared. Starting fresh. How can I help you?', 'bot');
        })
        .catch(err => {
          console.error('Failed to clear conversation:', err);
        });
      }
    }

    function appendMessage(text, sender) {
      const bubble = document.createElement("div");
      bubble.className = "bubble " + sender;
      
      // Format text to preserve newlines and basic formatting
      // Single <br> for line breaks, double <br><br> only for empty lines (paragraphs)
      const lines = text.split('\n');
      const formattedText = lines
        .map(line => line.trim())
        .reduce((acc, line, index) => {
          if (line.length === 0) {
            // Empty line - add paragraph break if previous wasn't empty
            if (index > 0 && lines[index - 1].trim().length > 0) {
              return acc + '<br>';
            }
            return acc;
          }
          // Non-empty line
          if (acc.length > 0) {
            return acc + '<br>' + line;
          }
          return line;
        }, '');
      
      bubble.innerHTML = formattedText;
      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

    function showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "typing-indicator";
      typingDiv.id = "typing-indicator";
      
      const dotsDiv = document.createElement("div");
      dotsDiv.className = "typing-dots";
      
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("span");
        dotsDiv.appendChild(dot);
      }
      
      typingDiv.appendChild(dotsDiv);
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById("typing-indicator");
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    async function sendMessage(e) {
      e.preventDefault();
      const message = msgInput.value.trim();
      if (!message) return;
      
      appendMessage(message, "user");
      msgInput.value = "";
      
      showTypingIndicator();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            user_type: userLoginState.user_type || 'guest',
            department: userLoginState.department,
            role: userLoginState.role
          })
        });
        
        hideTypingIndicator();
        
        const data = await response.json();
        const botResponse = data.response || "Sorry, I didn't understand that.";
        appendMessage(botResponse, "bot");
      } catch (err) {
        hideTypingIndicator();
        appendMessage("Couldn't reach server.", "bot");
      }
    }
  </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>